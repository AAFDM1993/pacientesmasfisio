<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema +FISIO Pro - Control de Sesiones</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f4f7f6; --blue: #3498db; --danger: #e74c3c; --kids: #e67e22; --gray: #95a5a6; --admin: #8e44ad; --fisio-tag: #e8f4fd; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        
        /* Pantalla Login */
        #login-screen { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 350px; }
        #login-screen input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        /* Layout */
        #main-app { display: none; width: 100%; max-width: 1250px; margin: 20px; grid-template-columns: 420px 1fr; gap: 20px; align-items: start; }
        .panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 85vh; }
        
        h2 { font-size: 1rem; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 8px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
        label { font-size: 0.8rem; font-weight: bold; color: #7f8c8d; display: block; margin-top: 10px; }
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 0.9rem; }
        
        /* Botones y Tags */
        .btn-save { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-clear { background: #eee; border: none; padding: 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; width: 100%; margin-bottom: 15px; }
        .btn-tag { background: #ebf5fb; border: 1px solid #d6eaf8; color: #2980b9; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; font-weight: bold; }
        .quick-notes { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }

        /* Tabs y Lista */
        .tabs { display: flex; gap: 5px; margin-bottom: 10px; background: #eee; padding: 5px; border-radius: 8px; }
        .tab { flex: 1; padding: 8px; text-align: center; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 0.75rem; color: #7f8c8d; }
        .tab.active[data-cat="Adultos"] { background: var(--blue); color: white; }
        .tab.active[data-cat="Kids"] { background: var(--kids); color: white; }
        .paciente-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; border-radius: 4px; }
        .paciente-item.active { background: var(--blue) !important; color: white !important; }
        .paciente-item.is-kid.active { background: var(--kids) !important; color: white !important; }

        /* Historial */
        .sesion-card { background: white; border-left: 5px solid var(--blue); padding: 15px; margin-bottom: 15px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .fisio-badge { background: var(--fisio-tag); color: #2980b9; padding: 2px 8px; border-radius: 10px; font-weight: bold; font-size: 0.7rem; }
        
        #loading-overlay { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; justify-content:center; align-items:center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:var(--primary)">+FISIO Gesti√≥n</h1>
        <input type="text" id="userInput" placeholder="Usuario">
        <input type="password" id="passInput" placeholder="Contrase√±a">
        <button class="btn-save" onclick="intentarLogin()">INGRESAR AL SISTEMA</button>
        <p id="login-error" style="color:var(--danger); font-size:0.8rem; display:none; margin-top:10px;">Acceso denegado</p>
    </div>

    <div id="loading-overlay"><strong>Sincronizando datos...</strong></div>

    <div id="main-app">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span id="welcome-user" style="font-size:0.75rem; font-weight:bold; color:var(--admin);"></span>
                <button onclick="location.reload()" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:0.7rem; text-decoration: underline;">Salir</button>
            </div>
            
            <h2>üìù Registrar Sesi√≥n</h2>
            <button class="btn-clear" onclick="limpiarFormulario()">+ NUEVO PACIENTE / LIMPIAR</button>

            <select id="reg-categoria"><option value="Adultos">Adulto üë®‚Äçüíº</option><option value="Kids">Kid üßí</option></select>
            <input type="text" id="dni" placeholder="DNI (ej: 04653286)">
            <input type="text" id="paciente" placeholder="Nombre completo">
            
            <label>Tratamientos R√°pidos <span onclick="toggleConfigTratamientos()" style="float:right; cursor:pointer;">‚öôÔ∏è</span></label>
            <div id="config-tratamientos" style="display:none; background:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:10px; border:1px dashed #ccc;">
                <input type="text" id="newTrat" placeholder="Ej: CF" style="width:70%; margin:0;">
                <button onclick="addNuevoTratamientoLista()" style="width:25%; background:var(--accent); color:white; border:none; padding:10px; border-radius:5px;">+</button>
                <div id="lista-config-trats" style="font-size:0.65rem; margin-top:5px; color:var(--gray);"></div>
            </div>
            <div id="quick-notes-container" class="quick-notes"></div>
            
            <textarea id="notas" rows="4" placeholder="Notas del tratamiento..."></textarea>
            <button class="btn-save" id="btnGuardar" onclick="guardarSesion()">üíæ GUARDAR SESI√ìN</button>

            <h2 style="margin-top:25px;">üë• Lista de Pacientes</h2>
            <div class="tabs">
                <div class="tab active" data-cat="Adultos" onclick="setFiltroCat('Adultos')">Adultos</div>
                <div class="tab" data-cat="Kids" onclick="setFiltroCat('Kids')">Kids</div>
            </div>
            <input type="text" id="buscador" placeholder="üîç Buscar nombre o DNI..." onkeyup="actualizarListaPacientes(this.value.toLowerCase())">
            <div id="listaPacientes" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:5px;"></div>

            <div id="admin-panel" style="display:none; margin-top:20px; padding:15px; border:1px solid var(--admin); border-radius:8px; background:#fdfaff;">
                <h2 style="color:var(--admin); border-color:var(--admin); font-size:0.8rem;">‚öôÔ∏è ADMINISTRACI√ìN DE USUARIOS</h2>
                <input type="text" id="admin-new-user" placeholder="Nombre de usuario">
                <input type="password" id="admin-new-pass" placeholder="Contrase√±a">
                <select id="admin-new-rol"><option value="Fisio">Fisio</option><option value="Admin">Admin</option></select>
                <button class="btn-save" style="background:var(--admin); font-size:0.8rem;" onclick="crearNuevoUsuario()">A√ëADIR PERSONAL</button>
            </div>
        </div>

        <div class="panel">
            <h2 id="tituloHistorial">Ficha del Paciente</h2>
            <div id="contenedorHistorial">
                <p style="text-align:center; color:#ccc; margin-top:100px;">Seleccione un paciente de la lista izquierda.</p>
            </div>
        </div>
    </div>

<script>
    const URL_WEB_APP = "https://script.google.com/macros/s/AKfycbzdr-KPx1eEk4YYU4g9vF5ZFsZ9qpDFbjHrKCRGhpTSnnzOBgM9kz-UTLtwNQ2uQPo3WQ/exec"; // REEMPLAZA ESTO
    
    let todasLasSesiones = [];
    let todosLosUsuarios = [];
    let usuarioLogueado = null;
    let filtroCategoria = "Adultos";
    let misTratamientos = JSON.parse(localStorage.getItem('trats_v2')) || ['CHC', 'TENS', 'CF', 'Magneto'];

    // SINCRONIZACI√ìN
    async function sincronizar() {
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            const res = await fetch(URL_WEB_APP);
            const data = await res.json();
            
            // Normalizar Sesiones (claves a min√∫sculas)
            todasLasSesiones = data.pacientes.map(s => {
                let n = {}; for(let k in s) n[k.toLowerCase()] = s[k]; return n;
            });
            // Normalizar Usuarios
            todosLosUsuarios = data.usuarios.map(u => {
                let n = {}; for(let k in u) n[k.toLowerCase()] = u[k]; return n;
            });

            if(usuarioLogueado) actualizarListaPacientes();
        } catch(e) { console.error("Error sincronizando:", e); }
        document.getElementById('loading-overlay').style.display = 'none';
    }

    // LOGIN
    function intentarLogin() {
        const uIn = document.getElementById('userInput').value.trim();
        const pIn = document.getElementById('passInput').value.trim();
        const user = todosLosUsuarios.find(u => u.usuario === uIn && String(u.password) === pIn);
        
        if(user) {
            usuarioLogueado = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'grid';
            document.getElementById('welcome-user').innerText = `USUARIO: ${user.usuario.toUpperCase()}`;
            if(user.rol === 'Admin') document.getElementById('admin-panel').style.display = 'block';
            actualizarListaPacientes();
            renderTratamientos();
        } else {
            document.getElementById('login-error').style.display = 'block';
        }
    }

    // GESTI√ìN TRATAMIENTOS
    function renderTratamientos() {
        const cont = document.getElementById('quick-notes-container');
        const listCfg = document.getElementById('lista-config-trats');
        cont.innerHTML = ''; listCfg.innerHTML = '';
        misTratamientos.forEach((t, i) => {
            const btn = document.createElement('div');
            btn.className = 'btn-tag'; btn.innerText = t; btn.onclick = () => {
                const area = document.getElementById('notas');
                area.value += (area.value ? ', ' : '') + t;
                area.focus();
            };
            cont.appendChild(btn);
            listCfg.innerHTML += `<div>‚Ä¢ ${t} <span onclick="removeTrat(${i})" style="color:red; cursor:pointer; float:right;">[Eliminar]</span></div>`;
        });
    }

    function toggleConfigTratamientos() {
        const d = document.getElementById('config-tratamientos');
        d.style.display = d.style.display === 'none' ? 'block' : 'none';
    }

    function addNuevoTratamientoLista() {
        const v = document.getElementById('newTrat').value.trim();
        if(v) { misTratamientos.push(v); localStorage.setItem('trats_v2', JSON.stringify(misTratamientos)); document.getElementById('newTrat').value=''; renderTratamientos(); }
    }

    function removeTrat(i) { misTratamientos.splice(i, 1); localStorage.setItem('trats_v2', JSON.stringify(misTratamientos)); renderTratamientos(); }

    // PACIENTES Y FILTROS
    function setFiltroCat(cat) {
        filtroCategoria = cat;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.tab[data-cat="${cat}"]`).classList.add('active');
        actualizarListaPacientes();
    }

    function actualizarListaPacientes(busqueda = "") {
        const lista = document.getElementById('listaPacientes');
        const mapaP = {};
        todasLasSesiones.forEach(s => mapaP[s.dni] = { nombre: s.paciente, cat: s.categoria || "Adultos" });
        
        lista.innerHTML = '';
        Object.keys(mapaP).sort().forEach(dni => {
            const p = mapaP[dni];
            if(p.cat === filtroCategoria && (p.nombre.toLowerCase().includes(busqueda) || dni.includes(busqueda))) {
                const div = document.createElement('div');
                div.className = `paciente-item ${p.cat === 'Kids' ? 'is-kid' : ''}`;
                div.innerHTML = `<strong>${p.nombre}</strong><br><small>DNI: ${dni}</small>`;
                div.onclick = (e) => {
                    document.getElementById('dni').value = dni;
                    document.getElementById('paciente').value = p.nombre;
                    document.getElementById('reg-categoria').value = p.cat;
                    document.querySelectorAll('.paciente-item').forEach(i => i.classList.remove('active'));
                    div.classList.add('active');
                    verHistorial(dni);
                };
                lista.appendChild(div);
            }
        });
    }

    function verHistorial(dni) {
        const filtradas = todasLasSesiones.filter(s => String(s.dni) === String(dni)).reverse();
        const cont = document.getElementById('contenedorHistorial');
        if(!filtradas.length) return;

        document.getElementById('tituloHistorial').innerHTML = `${filtradas[0].paciente} <button onclick="generarPDF('${dni}')" style="float:right; cursor:pointer; font-size:0.6rem; padding:4px;">üìÑ PDF</button>`;
        
        cont.innerHTML = filtradas.map(s => `
            <div class="sesion-card" style="border-left-color: ${s.categoria === 'Kids' ? 'var(--kids)' : 'var(--blue)'}">
                <div style="font-size:0.7rem; color:var(--gray); display:flex; justify-content:space-between; align-items:center;">
                    <span>üìÖ ${s.fecha}</span>
                    <span class="fisio-badge">ü©∫ ${s.atendido_por || '---'}</span>
                    <span onclick="eliminarSesion('${s.id}')" style="color:var(--danger); cursor:pointer; font-weight:bold;">‚úï</span>
                </div>
                <p style="margin-top:10px; font-size:0.9rem; line-height:1.4;">${s.notas}</p>
            </div>
        `).join('');
    }

    // ACCIONES CLOUD
    async function guardarSesion() {
        const dniInput = document.getElementById('dni').value.trim();
        const nombre = document.getElementById('paciente').value.trim();
        const notas = document.getElementById('notas').value.trim();
        
        if(!dniInput || !nombre || !notas) return alert("Completa DNI, Nombre y Notas.");

        document.getElementById('btnGuardar').disabled = true;
        const datos = { 
            action:'save', 
            id: Date.now(), 
            dni: String(dniInput), 
            paciente: nombre, 
            notas, 
            categoria: document.getElementById('reg-categoria').value, 
            fecha: new Date().toLocaleString(),
            atendido_por: usuarioLogueado.usuario
        };
        
        try {
            await fetch(URL_WEB_APP, { method:'POST', mode:'no-cors', body: JSON.stringify(datos) });
            document.getElementById('notas').value = '';
            setTimeout(sincronizar, 1500);
        } catch(e) { alert("Error al conectar con la base de datos."); }
        
        document.getElementById('btnGuardar').disabled = false;
    }

    async function eliminarSesion(id) {
        if(confirm("¬øSeguro que deseas eliminar esta sesi√≥n?")) {
            await fetch(URL_WEB_APP, { method:'POST', mode:'no-cors', body: JSON.stringify({action:'delete_session', id}) });
            setTimeout(sincronizar, 1000);
        }
    }

    async function crearNuevoUsuario() {
        const usuario = document.getElementById('admin-new-user').value.trim();
        const password = document.getElementById('admin-new-pass').value.trim();
        const rol = document.getElementById('admin-new-rol').value;
        if(!usuario || !password) return alert("Usuario y clave requeridos");

        await fetch(URL_WEB_APP, { method:'POST', mode:'no-cors', body: JSON.stringify({action:'save_user', usuario, password, rol}) });
        alert("Personal registrado.");
        sincronizar();
    }

    function limpiarFormulario() {
        document.getElementById('dni').value = '';
        document.getElementById('paciente').value = '';
        document.getElementById('notas').value = '';
        document.querySelectorAll('.paciente-item').forEach(i => i.classList.remove('active'));
    }

    function generarPDF(dni) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const f = todasLasSesiones.filter(s => String(s.dni) === String(dni)).reverse();
        if(!f.length) return;

        doc.setFontSize(16); doc.text(`REPORTE DE SESIONES: ${f[0].paciente.toUpperCase()}`, 20, 20);
        doc.setFontSize(10); doc.text(`DNI: ${dni} | Categor√≠a: ${f[0].categoria}`, 20, 28);
        doc.line(20, 32, 190, 32);
        
        let y = 42;
        f.forEach(s => {
            if(y > 270) { doc.addPage(); y = 20; }
            doc.setFont(undefined, 'bold'); doc.text(`${s.fecha} - Atendido por: ${s.atendido_por}`, 20, y);
            y += 7;
            doc.setFont(undefined, 'normal');
            const lines = doc.splitTextToSize(s.notas, 170);
            doc.text(lines, 20, y);
            y += (lines.length * 7) + 10;
        });
        doc.save(`Ficha_${f[0].paciente}.pdf`);
    }

    // ARRANQUE
    window.onload = sincronizar;
</script>
</body>
</html>
