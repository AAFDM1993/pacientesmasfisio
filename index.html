<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Cl√≠nico +FISIO</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f4f7f6; --blue: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; display: grid; grid-template-columns: 380px 1fr; gap: 20px; }
        .panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { font-size: 1.1rem; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .quick-notes { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .btn-tag { background: #ebf5fb; border: 1px solid #d6eaf8; color: #2980b9; padding: 8px 4px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; font-weight: bold; text-align: center; }
        .btn-save { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .paciente-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .paciente-item.active { background: var(--blue); color: white; border-radius: 6px; }
        .sesion-card { background: #fff; border-left: 5px solid var(--blue); padding: 15px; margin-bottom: 15px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #loading-overlay { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:100; justify-content:center; align-items:center; font-weight:bold; }
    </style>
</head>
<body>

<div id="loading-overlay">Sincronizando con la nube...</div>

<div class="container">
    <div class="panel">
        <h2>üìù Nuevo Registro</h2>
        <label>DNI:</label> <input type="text" id="dni">
        <label>Nombre:</label> <input type="text" id="paciente">
        <label>Tratamientos:</label>
        <div class="quick-notes">
            <div class="btn-tag" onclick="addNote('CHC')">CHC</div>
            <div class="btn-tag" onclick="addNote('CF')">CF</div>
            <div class="btn-tag" onclick="addNote('TENS')">TENS</div>
            <div class="btn-tag" onclick="addNote('IF')">IF</div>
            <div class="btn-tag" onclick="addNote('KOTZ')">KOTZ</div>
            <div class="btn-tag" onclick="addNote('MG')">MG</div>
            <div class="btn-tag" onclick="addNote('TC')">TC</div>
            <div class="btn-tag" onclick="addNote('KINESIO')">KINESIO</div>
        </div>
        <textarea id="notas" rows="4"></textarea>
        <button class="btn-save" id="btnGuardar" onclick="agregarSesion()">GUARDAR EN LA NUBE</button>
        <h2 style="margin-top: 30px;">üë• Pacientes</h2>
        <div id="listaPacientes">Cargando...</div>
    </div>

    <div class="panel">
        <h2 id="tituloHistorial">Historial Cl√≠nico</h2>
        <div id="contenedorHistorial">Seleccione un paciente.</div>
    </div>
</div>

<script>
    const URL_WEB_APP = "https://script.google.com/macros/s/AKfycbzE7heHqEeTY6iqsPsKCsD28tOoXJk0WEY9cLqc8i2WwELFcBCv7SphKBJza0sdTGwB0Q/exec"; 
    let todasLasSesiones = [];
    let pacienteSeleccionado = null;

    window.onload = cargarDatosDesdeNube;

    function addNote(text) {
        const area = document.getElementById('notas');
        area.value += (area.value ? ', ' : '') + text;
    }

    async function cargarDatosDesdeNube() {
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            const response = await fetch(URL_WEB_APP);
            todasLasSesiones = await response.json();
            actualizarListaPacientes();
            if(pacienteSeleccionado) verHistorial(pacienteSeleccionado);
        } catch (e) { console.error(e); }
        document.getElementById('loading-overlay').style.display = 'none';
    }

    async function agregarSesion() {
        const dni = document.getElementById('dni').value.trim();
        const nombre = document.getElementById('paciente').value.trim();
        const notas = document.getElementById('notas').value.trim();
        if (!dni || !nombre || !notas) return alert("Faltan datos");

        const datos = { action: 'save', id: Date.now(), dni, paciente: nombre, fecha: new Date().toLocaleString(), notas };
        await ejecutarAccionCloud(datos);
        document.getElementById('notas').value = '';
        cargarDatosDesdeNube();
    }

    async function eliminarSesion(id) {
        if (!confirm("¬øEliminar esta nota permanentemente?")) return;
        await ejecutarAccionCloud({ action: 'delete_session', id: id });
        cargarDatosDesdeNube();
    }

    async function eliminarPaciente(dni) {
        if (!confirm("¬øEliminar TODA la ficha y sesiones de este paciente? Esta acci√≥n no se puede deshacer.")) return;
        await ejecutarAccionCloud({ action: 'delete_patient', dni: dni });
        pacienteSeleccionado = null;
        document.getElementById('contenedorHistorial').innerHTML = "Paciente eliminado.";
        cargarDatosDesdeNube();
    }

    async function ejecutarAccionCloud(cuerpo) {
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            await fetch(URL_WEB_APP, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(cuerpo)
            });
        } catch (e) { alert("Error de conexi√≥n"); }
    }

    function actualizarListaPacientes() {
        const listaDiv = document.getElementById('listaPacientes');
        const mapa = {};
        todasLasSesiones.forEach(s => mapa[s.dni] = s.paciente);
        listaDiv.innerHTML = '';
        Object.keys(mapa).forEach(dni => {
            const div = document.createElement('div');
            div.className = `paciente-item ${String(dni) === String(pacienteSeleccionado) ? 'active' : ''}`;
            div.onclick = () => verHistorial(dni);
            div.innerHTML = `<strong>${mapa[dni]}</strong><br><small>DNI: ${dni}</small>`;
            listaDiv.appendChild(div);
        });
    }

    function verHistorial(dni) {
        pacienteSeleccionado = dni;
        actualizarListaPacientes();
        const filtradas = todasLasSesiones.filter(s => String(s.dni) === String(dni)).reverse();
        
        if (filtradas.length === 0) {
            document.getElementById('contenedorHistorial').innerHTML = "No hay registros.";
            return;
        }

        const nombreP = filtradas[0].paciente;
        document.getElementById('tituloHistorial').innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>Historial: ${nombreP}</span>
                <button onclick="eliminarPaciente('${dni}')" style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.7rem;">ELIMINAR PACIENTE</button>
            </div>`;

        const contenedor = document.getElementById('contenedorHistorial');
        contenedor.innerHTML = filtradas.map(s => `
            <div class="sesion-card">
                <div style="display:flex; justify-content:space-between; color:#95a5a6; font-size:0.8rem">
                    <span>üìÖ ${s.fecha}</span>
                    <span onclick="eliminarSesion('${s.id}')" style="color:#e74c3c; cursor:pointer;">‚úñ Eliminar nota</span>
                </div>
                <p style="white-space: pre-wrap; margin-top:10px;">${s.notas}</p>
            </div>
        `).join('');
    }
</script></body>
</html>


