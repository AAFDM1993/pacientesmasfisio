<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>+FISIO Pro | Gesti贸n Especializada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; --accent: #27ae60; --bg: #f0f2f5; 
            --blue: #3498db; --danger: #e74c3c; --admin: #8e44ad; 
            --gray: #7f8c8d; --white: #ffffff; --shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); 
            margin: 0; color: #333; line-height: 1.6;
        }

        /* PANTALLA DE CARGA (CORREGIDA) */
        #loading { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); z-index: 10000; justify-content: center; align-items: center; 
        }

        /* LOGIN */
        #login-screen { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            min-height: 100vh; padding: 20px; box-sizing: border-box;
        }
        .login-card {
            background: var(--white); padding: 40px; border-radius: 16px; 
            box-shadow: var(--shadow); width: 100%; max-width: 380px; text-align: center;
        }
        .logo-img { max-width: 180px; margin-bottom: 20px; }

        /* APP LAYOUT */
        #main-app { 
            display: none; max-width: 1300px; margin: 0 auto; padding: 20px;
            gap: 20px; grid-template-columns: 1fr; 
        }
        @media (min-width: 1024px) { #main-app { grid-template-columns: 420px 1fr; } }

        .panel { 
            background: var(--white); padding: 25px; border-radius: 12px; 
            box-shadow: var(--shadow); height: fit-content; box-sizing: border-box;
        }

        h2 { 
            font-size: 0.9rem; color: var(--primary); border-bottom: 2px solid #f0f2f5; 
            padding-bottom: 12px; text-transform: uppercase; margin-top: 0;
            display: flex; justify-content: space-between; align-items: center;
        }

        input, textarea { 
            width: 100%; padding: 12px; margin: 8px 0 16px 0; 
            border: 1.5px solid #e0e6ed; border-radius: 8px; font-size: 0.95rem; 
            box-sizing: border-box; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--blue); }

        /* CATEGORAS GRID */
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .cat-btn {
            background: #f8f9fa; border: 2px solid #e0e6ed; padding: 12px 5px;
            border-radius: 10px; text-align: center; cursor: pointer;
            font-size: 0.75rem; font-weight: 600; display: flex;
            flex-direction: column; align-items: center; gap: 5px; transition: 0.2s;
        }
        .cat-btn span { font-size: 1.2rem; }
        .cat-btn.active { 
            background: var(--blue); color: white; border-color: var(--blue); 
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); 
        }

        /* BOTONES */
        .btn-save { background: var(--accent); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-clear { background: #f1f3f5; color: var(--gray); border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-pdf { background: var(--blue); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; }

        /* LISTAS Y TARJETAS */
        .paciente-item { padding: 12px; border-bottom: 1px solid #f0f2f5; cursor: pointer; }
        .paciente-item:hover { background: #f8fbff; border-left: 4px solid var(--blue); }
        .sesion-card { border: 1px solid #eef2f6; padding: 18px; margin-bottom: 12px; border-radius: 10px; background: #fff; }
        .cat-tag { background: #e1f5fe; color: #0288d1; padding: 3px 10px; border-radius: 15px; font-size: 0.7rem; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading"><strong> Procesando informaci贸n...</strong></div>

    <div id="login-screen">
        <div class="login-card">
            <img src="logo.png" alt="Logo" class="logo-img" onerror="this.src='https://via.placeholder.com/150?text=FISIO+PRO'">
            <h2 style="border:none; justify-content:center;">Acceso Profesional</h2>
            <input type="text" id="userInput" placeholder="Usuario">
            <input type="password" id="passInput" placeholder="Contrase帽a">
            <button class="btn-save" onclick="login()">ENTRAR AL SISTEMA</button>
        </div>
    </div>

    <div id="main-app">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; background: #f8f9fa; padding: 8px; border-radius: 8px;">
                <small id="current-user-info" style="color:var(--admin); font-weight:bold;"></small>
                <a href="#" onclick="location.reload()" style="font-size:0.7rem; color:var(--danger); text-decoration:none; font-weight:bold;">Cerrar Sesi贸n</a>
            </div>

            <h2> Evoluci贸n del Paciente</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="text" id="dni" placeholder="DNI">
                <input type="text" id="paciente" placeholder="Nombre completo">
            </div>

            <label style="font-size: 0.7rem; font-weight: bold; color: var(--gray); margin-bottom: 5px; display: block;">ESPECIALIDAD:</label>
            <div id="grid-categorias" class="cat-grid">
                <div class="cat-btn active" onclick="seleccionarCat(this, 'Fisioterapia Traumatologica')"><span>Υ</span>Trauma</div>
                <div class="cat-btn" onclick="seleccionarCat(this, 'Fisioterapia Reumatologica')"><span></span>Reuma</div>
                <div class="cat-btn" onclick="seleccionarCat(this, 'Fisioterapia Neuropediatrica')"><span></span>Neuro Pedia</div>
                <div class="cat-btn" onclick="seleccionarCat(this, 'Fisioterapia Neuro adultos')"><span></span>Neuro Adultos</div>
            </div>
            <input type="hidden" id="categoria" value="Fisioterapia Traumatologica">

            <textarea id="notas" rows="4" placeholder="Detalles de la sesi贸n..."></textarea>
            
            <div style="display:flex; gap:10px;">
                <button class="btn-save" style="flex:2" onclick="guardarSesion()"> GUARDAR EVOLUCIN</button>
                <button class="btn-clear" style="flex:1" onclick="limpiarFormulario()">Ч</button>
            </div>

            <h2 style="margin-top:25px;"> Hist贸rico de Pacientes</h2>
            <input type="text" placeholder=" Buscar por nombre o DNI..." onkeyup="renderListaPacientes(this.value.toLowerCase())">
            <div id="listaPacientes" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;"></div>
        </div>

        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="tituloHistorial" style="border:none; margin:0;">Ficha Cl铆nica</h2>
                <button id="btnPdf" class="btn-pdf" style="display:none;" onclick="generarPDF()"> EXPORTAR PDF</button>
            </div>
            <div id="contenedorHistorial" style="margin-top:15px
