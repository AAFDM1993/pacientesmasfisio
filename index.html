<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expediente Fisioterapia con Gemini IA</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f4f7f6; --blue: #3498db; --ai-purple: #8e44ad; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; display: grid; grid-template-columns: 400px 1fr; gap: 20px; }
        
        .panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { font-size: 1.1rem; color: var(--primary); margin: 0 0 15px 0; border-bottom: 2px solid #eee; padding-bottom: 8px; text-transform: uppercase; }

        label { font-size: 0.85rem; font-weight: bold; color: #7f8c8d; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        /* Men√∫ de Notas R√°pidas */
        .quick-notes { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .btn-tag { 
            background: #ebf5fb; border: 1px solid #d6eaf8; color: #2980b9; padding: 8px 4px; 
            border-radius: 4px; font-size: 0.7rem; cursor: pointer; font-weight: bold; text-align: center;
            display: flex; align-items: center; justify-content: center; min-height: 40px;
        }
        .btn-tag:hover { background: #d6eaf8; }
        .btn-tag.long { grid-column: span 2; }

        /* Botones de Acci√≥n */
        .btn-save { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .btn-ai { width: 100%; background: var(--ai-purple); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-ai:disabled { background: #bdc3c7; cursor: not-allowed; }

        /* Estilos de IA */
        #ai-response { background: #fdf2ff; border: 1px dashed var(--ai-purple); padding: 15px; border-radius: 6px; margin-top: 15px; font-size: 0.9rem; color: #4b2c5e; display: none; line-height: 1.4; }

        .paciente-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; border-radius: 4px; display: flex; flex-direction: column; }
        .paciente-item.active { background: var(--blue); color: white; }
        .sesion-card { background: #fff; border-left: 5px solid var(--blue); padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="container">
    <div class="panel">
        <h2>üîë Configuraci√≥n AI</h2>
        <input type="password" id="apiKey" placeholder="Pega aqu√≠ tu Gemini API Key" style="margin-bottom: 20px;">

        <h2>üìù Registro de Sesi√≥n</h2>
        <label>DNI:</label>
        <input type="text" id="dni" placeholder="Documento de identidad">
        
        <label>Nombre:</label>
        <input type="text" id="paciente" placeholder="Nombre completo">
        
        <label>Tratamientos:</label>
        <div class="quick-notes">
            <div class="btn-tag" onclick="addNote('CHC')">CHC</div>
            <div class="btn-tag" onclick="addNote('CF')">CF</div>
            <div class="btn-tag" onclick="addNote('TENS')">TENS</div>
            <div class="btn-tag" onclick="addNote('IF')">IF</div>
            <div class="btn-tag" onclick="addNote('KOTZ')">KOTZ</div>
            <div class="btn-tag" onclick="addNote('MG')">MG</div>
            <div class="btn-tag" onclick="addNote('TC')">TC</div>
            <div class="btn-tag" onclick="addNote('KINESIO')">KINESIO</div>
            <div class="btn-tag long" onclick="addNote('Liberaci√≥n de tejidos blandos')">Lib. Tejidos Blandos</div>
            <div class="btn-tag long" onclick="addNote('Liberaci√≥n de cicatriz')">Lib. Cicatriz</div>
        </div>
        <textarea id="notas" rows="4" placeholder="Escriba notas adicionales..."></textarea>
        
        <button class="btn-ai" id="aiBtn" onclick="consultarGemini()">‚ú® Consultar con Gemini AI</button>
        <div id="ai-response"></div>
        <br>
        <button class="btn-save" onclick="agregarSesion()">üíæ GUARDAR SESI√ìN</button>

        <h2 style="margin-top: 30px;">üë• Mis Pacientes</h2>
        <div id="listaPacientes"></div>
    </div>

    <div class="panel">
        <h2 id="tituloHistorial">Ficha del Paciente</h2>
        <div id="contenedorHistorial"></div>
    </div>
</div>

<script>
    let pacienteSeleccionado = null;

    function addNote(text) {
        const area = document.getElementById('notas');
        area.value += (area.value ? ', ' : '') + text;
        area.focus();
    }

    async function consultarGemini() {
        const key = document.getElementById('apiKey').value;
        const notas = document.getElementById('notas').value;
        const respDiv = document.getElementById('ai-response');
        const btn = document.getElementById('aiBtn');

        if (!key) return alert("Por favor, ingresa tu API KEY de Gemini.");
        if (!notas) return alert("Escribe algo en las notas para que la IA pueda ayudarte.");

        btn.disabled = true;
        btn.innerText = "Pensando...";
        respDiv.style.display = "block";
        respDiv.innerText = "Cargando sugerencia cl√≠nica...";

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Eres un asistente experto en fisioterapia. Basado en estos tratamientos/notas: "${notas}", brinda un breve resumen profesional, posibles beneficios esperados y una recomendaci√≥n para la siguiente sesi√≥n. S√© conciso.` }] }]
                })
            });

            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;
            respDiv.innerText = aiText;
        } catch (error) {
            respDiv.innerText = "Error al conectar con Gemini. Revisa tu API Key.";
        } finally {
            btn.disabled = false;
            btn.innerText = "‚ú® Consultar con Gemini AI";
        }
    }

    function agregarSesion() {
        const dni = document.getElementById('dni').value.trim();
        const nombre = document.getElementById('paciente').value.trim();
        const notas = document.getElementById('notas').value.trim();
        const aiSugerencia = document.getElementById('ai-response').innerText;
        
        if (!dni || !nombre || !notas) return alert('Faltan datos.');

        const ahora = new Date();
        const fechaAuto = ahora.toLocaleDateString() + ' ' + ahora.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        // Guardamos las notas + la sugerencia de la IA si existe
        const notasFinales = aiSugerencia && aiSugerencia !== "Cargando sugerencia cl√≠nica..." 
            ? `${notas}\n\n--- Sugerencia IA ---\n${aiSugerencia}` 
            : notas;

        const nuevaSesion = {
            id: Date.now(),
            dni: dni,
            paciente: nombre,
            fecha: fechaAuto,
            notas: notasFinales
        };

        let sesiones = JSON.parse(localStorage.getItem('fisioterapia_ai_v1')) || [];
        sesiones.push(nuevaSesion);
        localStorage.setItem('fisioterapia_ai_v1', JSON.stringify(sesiones));

        document.getElementById('notas').value = '';
        document.getElementById('ai-response').style.display = 'none';
        actualizarInterfaz();
        verHistorial(dni);
    }

    // (Funciones de historial y borrado id√©nticas a la versi√≥n anterior)
    function actualizarInterfaz() {
        const listaDiv = document.getElementById('listaPacientes');
        const sesiones = JSON.parse(localStorage.getItem('fisioterapia_ai_v1')) || [];
        const mapaPacientes = {};
        sesiones.forEach(s => mapaPacientes[s.dni] = s.paciente);
        listaDiv.innerHTML = '';
        Object.keys(mapaPacientes).sort().forEach(dni => {
            const div = document.createElement('div');
            div.className = `paciente-item ${pacienteSeleccionado === dni ? 'active' : ''}`;
            div.onclick = () => verHistorial(dni);
            div.innerHTML = `<strong>${mapaPacientes[dni]}</strong><span style="font-size:0.7rem">DNI: ${dni}</span>`;
            listaDiv.appendChild(div);
        });
    }

    function verHistorial(dni) {
        pacienteSeleccionado = dni;
        actualizarInterfaz();
        const contenedor = document.getElementById('contenedorHistorial');
        const sesiones = JSON.parse(localStorage.getItem('fisioterapia_ai_v1')) || [];
        const filtradas = sesiones.filter(s => s.dni === dni).reverse();
        if(filtradas.length === 0) return;
        document.getElementById('tituloHistorial').innerHTML = `Historial: ${filtradas[0].paciente}`;
        contenedor.innerHTML = '';
        filtradas.forEach(s => {
            const card = document.createElement('div');
            card.className = 'sesion-card';
            card.innerHTML = `<div>üìÖ ${s.fecha}</div><div style="white-space: pre-wrap; margin-top:10px;">${s.notas}</div>`;
            contenedor.appendChild(card);
        });
    }
</script>
</body>
</html>
