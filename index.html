<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>+FISIO | Gesti√≥n</title>
    <style>
        :root { 
            --primary: #2c3e50; --accent: #27ae60; --bg: #f0f2f5; 
            --blue: #3498db; --danger: #e74c3c; --admin: #8e44ad; 
            --gray: #7f8c8d; --white: #ffffff; --shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; color: #333; }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #login-screen { display: none; align-items: center; justify-content: center; min-height: 100vh; }
        .login-card { background: white; padding: 40px; border-radius: 16px; box-shadow: var(--shadow); width: 380px; text-align: center; }
        
        #main-app { display: none; max-width: 1300px; margin: 0 auto; padding: 20px; gap: 20px; grid-template-columns: 1fr; }
        @media (min-width: 1024px) { #main-app { display: grid; grid-template-columns: 450px 1fr; } }
        
        .panel { background: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; box-sizing: border-box; }
        h3 { margin-top: 0; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; font-size: 1.1rem; color: var(--primary); }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        input, textarea, select { width: 100%; padding: 12px; border: 1.5px solid #e0e6ed; border-radius: 8px; font-size: 0.95rem; outline: none; box-sizing: border-box; }
        
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; }
        .cat-btn { background: #f8f9fa; border: 1.5px solid #e0e6ed; padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; font-size: 0.8rem; font-weight: 600; transition: all 0.3s; }
        .cat-btn.active { background: var(--blue); color: white; border-color: var(--blue); }
        .cat-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-save { background: var(--accent); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .btn-save:hover { background: #229954; transform: translateY(-2px); }
        .btn-clear { background: var(--gray); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .btn-clear:hover { background: #5d6d7e; }
        .btn-pdf { background: var(--blue); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: all 0.3s; }
        .btn-pdf:hover { background: #2874a6; }
        
        .paciente-item { padding: 12px; border-bottom: 1px solid #f0f2f5; cursor: pointer; transition: all 0.2s; }
        .paciente-item:hover { background: #f8fbff; transform: translateX(5px); }
        .sesion-card { border: 1px solid #eef2f6; padding: 15px; border-radius: 10px; margin-bottom: 15px; transition: all 0.3s; position: relative; }
        .sesion-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        
        .btn-delete { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--danger); cursor: pointer; font-size: 20px; font-weight: bold; padding: 5px 10px; border-radius: 4px; transition: all 0.2s; }
        .btn-delete:hover { background: var(--danger); color: white; }
        
        /* Calendario */
        .calendar-container { background: white; border-radius: 8px; padding: 15px; }
        #calendar-content { 
            transition: all 0.3s ease; 
            overflow: hidden;
        }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-header button { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--blue); padding: 5px 10px; }
        .calendar-header button:hover { background: #f0f2f5; border-radius: 4px; }
        #calendar-toggle-btn { 
            transition: transform 0.3s ease, background 0.2s ease;
        }
        #calendar-toggle-btn:hover { 
            background: #e3f2fd !important; 
            border-radius: 4px;
        }
        .calendar-title { font-weight: bold; color: var(--primary); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-header { text-align: center; font-size: 0.75rem; font-weight: bold; color: var(--gray); padding: 5px; }
        .calendar-day { text-align: center; padding: 8px; cursor: pointer; border-radius: 4px; font-size: 0.85rem; transition: all 0.2s; position: relative; }
        .calendar-day:hover { background: #e3f2fd; }
        .calendar-day.other-month { color: #ccc; }
        .calendar-day.today { background: var(--blue); color: white; font-weight: bold; }
        .calendar-day.selected { background: var(--accent); color: white; }
        .calendar-day.has-appointments { background: #fff3cd; }
        .calendar-day.has-appointments::after { content: '‚Ä¢'; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); color: var(--blue); font-size: 16px; }
        
        /* Lista de citas */
        .appointments-list { margin-top: 15px; max-height: 200px; overflow-y: auto; }
        .appointment-item { background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid var(--blue); display: flex; justify-content: space-between; align-items: center; }
        .appointment-item:hover { background: #e9ecef; }
        .appointment-time { font-weight: bold; color: var(--blue); font-size: 0.9rem; }
        .appointment-patient { font-size: 0.85rem; color: var(--primary); }
        .appointment-delete { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 16px; padding: 0 5px; }
        .appointment-delete:hover { color: #c0392b; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 10% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .modal-header { margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: var(--primary); }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <p id="loading-text" style="margin-top:15px; font-weight:bold;">Cargando sistema...</p>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <img src="logo.png" alt="+FISIO Logo" style="width: 300px; height: auto; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto;">
            <h1 style="color:var(--blue); margin:0 0 10px 0;"> </h1>
            <p style="color:var(--gray); margin-bottom: 20px;">Sistema de Gesti√≥n de Pacientes</p>
            <input type="text" id="userInput" placeholder="Usuario" style="margin-bottom:10px;">
            <input type="password" id="passInput" placeholder="Contrase√±a" style="margin-bottom:10px;">
            <button class="btn-save" onclick="login()" style="width:100%; margin-top:10px;">INGRESAR</button>
            <p id="error-msg" style="color:var(--danger); display:none; margin-top:15px;">‚ö†Ô∏è Credenciales incorrectas</p>
        </div>
    </div>

    <!-- Modal Cambiar Contrase√±a -->
    <div id="modalPassword" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="cerrarModalPassword()">&times;</span>
                <h2>üîê Cambiar Contrase√±a</h2>
            </div>
            <input type="password" id="pass-actual" placeholder="Contrase√±a actual" style="margin-bottom:10px;">
            <input type="password" id="pass-nueva" placeholder="Nueva contrase√±a" style="margin-bottom:10px;">
            <input type="password" id="pass-confirmar" placeholder="Confirmar nueva contrase√±a" style="margin-bottom:20px;">
            <button class="btn-save" onclick="cambiarPassword()" style="width:100%;">CAMBIAR CONTRASE√ëA</button>
        </div>
    </div>

    <!-- Modal Agendar Cita -->
    <div id="modalCita" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="cerrarModalCita()">&times;</span>
                <h2>üìÖ Agendar Cita</h2>
            </div>
            <p style="margin-bottom:10px;"><strong id="cita-fecha-texto"></strong></p>
            <input type="time" id="cita-hora" style="margin-bottom:10px;">
            <input type="text" id="cita-paciente-dni" placeholder="DNI del paciente" style="margin-bottom:10px;" oninput="buscarPacienteCita(this.value)">
            <input type="text" id="cita-paciente-nombre" placeholder="Nombre del paciente" style="margin-bottom:10px;">
            <textarea id="cita-notas" rows="3" placeholder="Notas de la cita (opcional)" style="margin-bottom:20px;"></textarea>
            <button class="btn-save" onclick="agendarCita()" style="width:100%;">AGENDAR CITA</button>
        </div>
    </div>

    <div id="main-app">
        <aside>
            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer; user-select:none;" onclick="toggleCalendar()">
                    <h3 style="margin:0;">üìÖ Calendario de Citas</h3>
                    <button id="calendar-toggle-btn" style="background:none; border:none; font-size:20px; cursor:pointer; color:var(--blue); padding:5px;" title="Mostrar/Ocultar calendario">‚ñº</button>
                </div>
                <div id="calendar-content" style="margin-top:15px;">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button onclick="cambiarMes(-1)">‚óÄ</button>
                            <div class="calendar-title" id="calendar-title"></div>
                            <button onclick="cambiarMes(1)">‚ñ∂</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid"></div>
                    </div>
                    <div class="appointments-list" id="appointments-list"></div>
                </div>
            </div>

            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="logo.png" alt="+FISIO Logo" style="width: 35px; height: auto;">
                        <span id="user-tag" style="font-weight:bold; color:var(--admin);"></span>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="abrirModalPassword()" style="background:none; border:none; color:var(--blue); cursor:pointer; font-weight:bold;" title="Cambiar contrase√±a">üîê</button>
                        <button onclick="cerrarSesion()" style="background:none; border:none; color:var(--danger); cursor:pointer; font-weight:bold;">SALIR</button>
                    </div>
                </div>
                <h3>üìù Registro de Sesi√≥n</h3>
                <div class="form-row">
                    <input type="text" id="dni" placeholder="DNI" oninput="autoBuscar(this.value)">
                    <input type="text" id="paciente" placeholder="Nombre completo">
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="font-size: 0.9rem; color: var(--gray); margin-bottom: 5px; display: block;">Tipo de Atenci√≥n:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button type="button" class="tipo-atencion-btn active" onclick="setTipoAtencion(this, 'evaluacion')" data-tipo="evaluacion" style="background: var(--accent); color: white; border: 2px solid var(--accent); padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.3s;">
                            üìã Evaluaci√≥n
                        </button>
                        <button type="button" class="tipo-atencion-btn" onclick="setTipoAtencion(this, 'sesion')" data-tipo="sesion" style="background: white; color: var(--blue); border: 2px solid var(--blue); padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.3s;">
                            üí™ Sesi√≥n
                        </button>
                    </div>
                    <input type="hidden" id="tipo-atencion" value="evaluacion">
                </div>
                
                <div class="cat-grid">
                    <div class="cat-btn active" onclick="setCat(this, 'Fisioterapia Traumatol√≥gica')">ü¶¥ Trauma</div>
                    <div class="cat-btn" onclick="setCat(this, 'Fisioterapia Reumatol√≥gica')">üíß Reuma</div>
                    <div class="cat-btn" onclick="setCat(this, 'Neuropediatr√≠a')">üë∂ Neuro Pedia</div>
                    <div class="cat-btn" onclick="setCat(this, 'Neuro Adultos')">üß† Neuro Adulto</div>
                </div>
                <input type="hidden" id="categoria" value="Fisioterapia Traumatol√≥gica">
                <textarea id="notas" rows="6" placeholder="Detalles de la evoluci√≥n..."></textarea>
                <div class="btn-group">
                    <button class="btn-save" onclick="guardar()">GUARDAR</button>
                    <button class="btn-clear" onclick="limpiarCampos()">LIMPIAR</button>
                </div>
            </div>

            <div class="panel">
                <h3>üë• Buscador de Pacientes</h3>
                <input type="text" placeholder="üîç Buscar por nombre o DNI..." onkeyup="renderLista(this.value)">
                <div id="listaPacientes" style="max-height: 250px; overflow-y: auto; margin-top:10px;"></div>
                <button id="btnAdmin" class="btn-save" onclick="toggleAdmin()" style="display:none; margin-top:20px; background:var(--admin); width:100%;">‚öôÔ∏è PANEL ADMIN</button>
            </div>

            <div id="admin-panel" class="panel" style="display:none; border:2px solid var(--admin);">
                <h3 style="color:var(--admin)">üîë Nuevo Usuario</h3>
                <input type="text" id="adm-nombre" placeholder="Nombre completo" style="margin-bottom:10px;">
                <select id="adm-rol" style="margin-bottom:10px;">
                    <option value="profesional">Profesional</option>
                    <option value="admin">Administrador</option>
                </select>
                <input type="text" id="adm-user" placeholder="Usuario" style="margin-bottom:10px;">
                <input type="password" id="adm-pass" placeholder="Contrase√±a" style="margin-bottom:10px;">
                <button class="btn-save" style="background:var(--admin); width:100%;" onclick="crearUsuario()">CREAR USUARIO</button>
            </div>
        </aside>

        <main class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;">
                <h2 id="titulo-historial" style="margin:0;">üìã Ficha Cl√≠nica</h2>
                <div>
                    <button id="btnSync" class="btn-pdf" onclick="sincronizar()" title="Sincronizar datos">üîÑ</button>
                    <button id="btnPdf" class="btn-pdf" style="display:none;" onclick="exportarPDF()">üì• EXPORTAR PDF</button>
                </div>
            </div>
            <div id="historial-body" style="margin-top:20px;"></div>
        </main>
    </div>

<script>
    const CONFIG = {
        webAppUrl: 'https://script.google.com/macros/s/AKfycbxPfCv17UfZzNudA6xAuoVZFMYbDtHyfnaWTbywEwUDqAEXQC3XG8d2LXBijxPjYop6/exec'
    };
    
    let db = { pacientes: [], usuarios: [], citas: [] };
    let currentUser = null;
    let selectedDni = "";
    let currentDate = new Date();
    let selectedDate = null;

    function init() {
        cargarCitas();
        cargarDatos();
    }

    async function cargarDatos(mostrarCarga = true) {
        try {
            if (mostrarCarga) {
                showLoad(true, 'Cargando sistema...');
            }
            
            const url = `${CONFIG.webAppUrl}?action=loadData`;
            const response = await fetch(url);
            
            if (!response.ok) throw new Error('Error al conectar');
            
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            
            // Procesar pacientes asegurando que DNI siempre sea String
            db.pacientes = (data.pacientes || []).map(p => ({
                ...p,
                dni: String(p.dni || ''),
                id: String(p.id || '')
            }));
            
            // Procesar usuarios
            db.usuarios = data.usuarios || [];
            
            if (mostrarCarga) {
                showLoad(false);
                document.getElementById('login-screen').style.display = 'flex';
            }
        } catch (error) {
            if (mostrarCarga) showLoad(false);
            alert('‚ùå Error al cargar datos: ' + error.message);
        }
    }

    function login() {
        const u = document.getElementById('userInput').value.trim();
        const p = document.getElementById('passInput').value.trim();
        
        const user = db.usuarios.find(x => x.usuario === u && x.password === p);

        if(user || (u === "admin" && p === "1234")) {
            currentUser = user || { nombre_completo: "Admin Maestro", rol: "admin", usuario: "admin" };
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'grid';
            document.getElementById('user-tag').innerText = "üë§ " + currentUser.nombre_completo;
            
            // Solo mostrar panel admin si es admin
            if(currentUser.rol === "admin") {
                document.getElementById('btnAdmin').style.display = 'block';
            }
            
            renderLista();
            renderCalendar();
            restaurarEstadoCalendar(); // Restaurar estado del calendario
        } else {
            document.getElementById('error-msg').style.display = 'block';
            setTimeout(() => {
                document.getElementById('error-msg').style.display = 'none';
            }, 3000);
        }
    }

    // ============================================
    // CAMBIAR CONTRASE√ëA
    // ============================================
    
    function abrirModalPassword() {
        document.getElementById('modalPassword').style.display = 'block';
        document.getElementById('pass-actual').value = '';
        document.getElementById('pass-nueva').value = '';
        document.getElementById('pass-confirmar').value = '';
    }
    
    function cerrarModalPassword() {
        document.getElementById('modalPassword').style.display = 'none';
    }
    
    async function cambiarPassword() {
        const passActual = document.getElementById('pass-actual').value.trim();
        const passNueva = document.getElementById('pass-nueva').value.trim();
        const passConfirmar = document.getElementById('pass-confirmar').value.trim();
        
        if (!passActual || !passNueva || !passConfirmar) {
            alert('‚ö†Ô∏è Completa todos los campos');
            return;
        }
        
        if (passNueva !== passConfirmar) {
            alert('‚ö†Ô∏è Las contrase√±as no coinciden');
            return;
        }
        
        if (passNueva.length < 4) {
            alert('‚ö†Ô∏è La contrase√±a debe tener al menos 4 caracteres');
            return;
        }
        
        showLoad(true, 'Cambiando contrase√±a...');
        
        const payload = {
            action: 'change_password',
            usuario: currentUser.usuario,
            password_actual: passActual,
            password_nueva: passNueva
        };
        
        try {
            const response = await fetch(CONFIG.webAppUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                cerrarModalPassword();
                
                showLoad(false);
                mostrarNotificacion('‚úÖ Contrase√±a cambiada');
                alert('‚úÖ Contrase√±a actualizada correctamente');
                
                // Recargar datos en segundo plano sin mostrar pantalla
                cargarDatos(false);
            } else {
                throw new Error(result.message || 'Error al cambiar contrase√±a');
            }
        } catch (error) {
            showLoad(false);
            alert('‚ùå Error: ' + error.message);
        }
    }

    async function guardar() {
        const dniInput = document.getElementById('dni').value.trim();
        const paciente = document.getElementById('paciente').value.trim();
        const notas = document.getElementById('notas').value.trim();
        const tipoAtencion = document.getElementById('tipo-atencion').value;
        
        if(!dniInput || !notas || !paciente) {
            alert("‚ö†Ô∏è Faltan datos: DNI, Nombre y Notas son obligatorios");
            return;
        }

        showLoad(true, "Guardando...");
        
        // Formatear fecha en formato legible: "16/02/2026 04:33 PM"
        const ahora = new Date();
        const dia = String(ahora.getDate()).padStart(2, '0');
        const mes = String(ahora.getMonth() + 1).padStart(2, '0');
        const anio = ahora.getFullYear();
        
        let horas = ahora.getHours();
        const minutos = String(ahora.getMinutes()).padStart(2, '0');
        const ampm = horas >= 12 ? 'PM' : 'AM';
        horas = horas % 12;
        horas = horas ? horas : 12; // 0 se convierte en 12
        const horasStr = String(horas).padStart(2, '0');
        
        const fechaFormateada = `${dia}/${mes}/${anio} ${horasStr}:${minutos} ${ampm}`;
        
        // IMPORTANTE: Mantener DNI como String desde el inicio
        const nuevaSesion = {
            action: 'save',
            id: String(Date.now()),
            dni: dniInput,
            paciente: paciente,
            categoria: document.getElementById('categoria').value,
            tipo_atencion: tipoAtencion, // Guardar tipo seleccionado manualmente
            notas: notas,
            fecha: fechaFormateada,
            atendido_por: currentUser.nombre_completo
        };
        
        try {
            const response = await fetch(CONFIG.webAppUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(nuevaSesion)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // Agregar a la base de datos local sin modificar la referencia
                db.pacientes = [...db.pacientes, nuevaSesion];
                
                // Actualizar historial inmediatamente
                verHistorial(dniInput);
                
                // Limpiar notas
                document.getElementById('notas').value = "";
                
                // Resetear a "Sesi√≥n" despu√©s de guardar
                const btnSesion = document.querySelector('[data-tipo="sesion"]');
                if (btnSesion) {
                    setTipoAtencion(btnSesion, 'sesion');
                }
                
                showLoad(false);
                mostrarNotificacion('‚úÖ Sesi√≥n guardada');
                
                // Recargar datos en segundo plano sin mostrar pantalla
                setTimeout(() => cargarDatos(false), 500);
            } else {
                throw new Error(result.message || 'Error al guardar');
            }
        } catch (error) {
            showLoad(false);
            alert('‚ùå Error: ' + error.message);
        }
    }
        
        try {
            const response = await fetch(CONFIG.webAppUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(nuevaSesion)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // Agregar a la base de datos local sin modificar la referencia
                db.pacientes = [...db.pacientes, nuevaSesion];
                
                // Actualizar historial inmediatamente
                verHistorial(dniInput);
                
                // Limpiar notas
                document.getElementById('notas').value = "";
                
                showLoad(false);
                mostrarNotificacion(`‚úÖ ${tipoAtencion} guardada`);
                
                // Recargar datos en segundo plano sin mostrar pantalla
                setTimeout(() => cargarDatos(false), 500);
            } else {
                throw new Error(result.message || 'Error al guardar');
            }
        } catch (error) {
            showLoad(false);
            alert('‚ùå Error: ' + error.message);
        }
    }

    // ============================================
    // ELIMINAR SESI√ìN
    // ============================================
    
    async function eliminarSesion(id) {
        if (!confirm('¬øEst√° seguro de eliminar esta sesi√≥n?\n\nEsta acci√≥n no se puede deshacer.')) {
            return;
        }
        
        showLoad(true, 'Eliminando...');
        
        const payload = {
            action: 'delete_session',
            id: id
        };
        
        try {
            const response = await fetch(CONFIG.webAppUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // Eliminar localmente sin modificar la referencia
                db.pacientes = db.pacientes.filter(p => p.id !== id);
                
                // Actualizar historial inmediatamente
                verHistorial(selectedDni);
                
                showLoad(false);
                mostrarNotificacion('‚úÖ Sesi√≥n eliminada');
                
                // Recargar datos en segundo plano sin mostrar pantalla
                setTimeout(() => cargarDatos(false), 500);
            } else {
                throw new Error(result.message || 'Error al eliminar');
            }
        } catch (error) {
            showLoad(false);
            alert('‚ùå Error: ' + error.message);
        }
    }

    async function crearUsuario() {
        const nombre = document.getElementById('adm-nombre').value.trim();
        const usuario = document.getElementById('adm-user').value.trim();
        const password = document.getElementById('adm-pass').value.trim();
        const rol = document.getElementById('adm-rol').value;

        if(!nombre || !usuario || !password) {
            alert("‚ö†Ô∏è Completa todos los campos");
            return;
        }
        
        if (db.usuarios.find(u => u.usuario === usuario)) {
            alert("‚ö†Ô∏è El usuario ya existe");
            return;
        }

        showLoad(true, "Creando usuario...");
        
        const payload = {
            action: 'add_user',
            nombre_completo: nombre,
            usuario: usuario,
            password: password,
            rol: rol
        };
        
        try {
            const response = await fetch(CONFIG.webAppUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // Limpiar formulario
                document.getElementById('adm-nombre').value = "";
                document.getElementById('adm-user').value = "";
                document.getElementById('adm-pass').value = "";
                
                showLoad(false);
                mostrarNotificacion('‚úÖ Usuario creado');
                alert(`‚úÖ Usuario creado\n\nUsuario: ${usuario}\nContrase√±a: ${password}\n\n¬°Ya puede iniciar sesi√≥n!`);
                
                // Recargar datos en segundo plano sin mostrar pantalla
                cargarDatos(false);
            } else {
                throw new Error(result.message || 'Error al crear usuario');
            }
        } catch (error) {
            showLoad(false);
            alert('‚ùå Error: ' + error.message);
        }
    }

    function renderLista(filtro = "") {
        const div = document.getElementById('listaPacientes');
        const unicos = {};
        // Asegurar que DNI siempre sea String
        db.pacientes.forEach(p => {
            const dniStr = String(p.dni || '');
            if (dniStr) {
                unicos[dniStr] = p.paciente;
            }
        });
        
        const keys = Object.keys(unicos).filter(d => 
            unicos[d].toLowerCase().includes(filtro.toLowerCase()) || d.includes(filtro)
        );

        if(keys.length === 0) {
            div.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">üîç Sin resultados</p>';
            return;
        }

        div.innerHTML = keys.map(d => `
            <div class="paciente-item" onclick="seleccionar('${d}', '${unicos[d].replace(/'/g, "\\'")}')">
                <strong>${unicos[d]}</strong><br>
                <small style="color: var(--gray);">DNI: ${d}</small>
            </div>
        `).join('');
    }

    function seleccionar(d, n) {
        document.getElementById('dni').value = d;
        document.getElementById('paciente').value = n;
        verHistorial(d);
    }

    function verHistorial(d) {
        selectedDni = String(d || '');
        // Filtrar asegurando comparaci√≥n de strings
        const filtrados = db.pacientes.filter(x => String(x.dni || '') === selectedDni).reverse();
        document.getElementById('btnPdf').style.display = filtrados.length ? 'inline-block' : 'none';
        document.getElementById('titulo-historial').innerText = "üìã Historial: " + (filtrados[0]?.paciente || "Sin paciente");
        
        if(filtrados.length === 0) {
            document.getElementById('historial-body').innerHTML = '<div style="text-align:center; padding:60px 20px; color:#95a5a6;"><h3>üìã Sin registros</h3><p>No hay sesiones previas para este paciente</p></div>';
            return;
        }

        document.getElementById('historial-body').innerHTML = filtrados.map((s, idx) => {
            // Usar el campo tipo_atencion guardado
            const tipoAtencion = s.tipo_atencion || 'sesion';
            const esEvaluacion = tipoAtencion === 'evaluacion';
            
            // Contar sesiones (solo las que NO son evaluaci√≥n)
            const sesionesHastaEsta = filtrados.slice(0, filtrados.length - idx + 1)
                .filter(x => (x.tipo_atencion || 'sesion') === 'sesion').length;
            
            const etiqueta = esEvaluacion ? 'EVALUACI√ìN FISIOTERAP√âUTICA' : `SESI√ìN #${sesionesHastaEsta}`;
            const colorEtiqueta = esEvaluacion ? 'var(--accent)' : 'var(--blue)';
            
            return `
            <div class="sesion-card">
                <button class="btn-delete" onclick="eliminarSesion('${s.id}')" title="Eliminar sesi√≥n">‚úï</button>
                <div style="display:flex; justify-content:space-between; align-items:center; padding-right:30px;">
                    <small style="color: var(--primary);"><b>üìÖ ${s.fecha}</b></small>
                    <span style="background: ${colorEtiqueta}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">${etiqueta}</span>
                </div>
                <div style="color:var(--blue); font-size:0.85rem; margin:8px 0; font-weight:600;">
                    ${s.categoria}
                </div>
                <div style="color:var(--gray); font-size:0.8rem; margin-bottom:12px;">
                    üë®‚Äç‚öïÔ∏è Atendi√≥: ${s.atendido_por}
                </div>
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid ${colorEtiqueta};">
                    <p style="margin:0; line-height:1.6; white-space: pre-wrap;">${s.notas}</p>
                </div>
            </div>
        `}).join('');
    }

    function autoBuscar(val) {
        const valTrimmed = String(val || '').trim();
        const p = db.pacientes.find(x => String(x.dni || '') === valTrimmed);
        if(p) { 
            document.getElementById('paciente').value = p.paciente; 
            verHistorial(valTrimmed); 
        }
    }

    function setCat(el, v) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('categoria').value = v;
    }
    
    function setTipoAtencion(el, tipo) {
        // Remover active de todos
        document.querySelectorAll('.tipo-atencion-btn').forEach(b => {
            b.classList.remove('active');
            if (b.dataset.tipo === 'evaluacion') {
                b.style.background = 'white';
                b.style.color = 'var(--accent)';
            } else {
                b.style.background = 'white';
                b.style.color = 'var(--blue)';
            }
        });
        
        // Activar el seleccionado
        el.classList.add('active');
        if (tipo === 'evaluacion') {
            el.style.background = 'var(--accent)';
            el.style.color = 'white';
        } else {
            el.style.background = 'var(--blue)';
            el.style.color = 'white';
        }
        
        document.getElementById('tipo-atencion').value = tipo;
    }

    function limpiarCampos() {
        document.getElementById('dni').value = "";
        document.getElementById('paciente').value = "";
        document.getElementById('notas').value = "";
        document.querySelectorAll('.cat-btn').forEach((b, i) => {
            if(i === 0) b.classList.add('active');
            else b.classList.remove('active');
        });
        document.getElementById('categoria').value = "Fisioterapia Traumatol√≥gica";
    }

    function toggleAdmin() {
        const p = document.getElementById('admin-panel');
        p.style.display = p.style.display === 'none' ? 'block' : 'none';
    }

    function cerrarSesion() {
        if(confirm('¬øCerrar sesi√≥n?')) {
            currentUser = null;
            selectedDni = "";
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('userInput').value = "";
            document.getElementById('passInput').value = "";
        }
    }

    function sincronizar() {
        mostrarNotificacion('üîÑ Sincronizando...');
        cargarDatos(false).then(() => {
            if (selectedDni) {
                verHistorial(selectedDni);
            }
            renderLista();
        });
    }

    function exportarPDF() {
        if(!selectedDni) {
            alert("‚ö†Ô∏è Selecciona un paciente primero");
            return;
        }
        
        const filtrados = db.pacientes.filter(x => String(x.dni || '') === selectedDni);
        if(filtrados.length === 0) {
            alert("‚ö†Ô∏è No hay sesiones para exportar");
            return;
        }
        
        const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
        const logoUrl = baseUrl + 'logo.png';
        
        // Formatear fecha actual
        const ahora = new Date();
        const dia = String(ahora.getDate()).padStart(2, '0');
        const mes = String(ahora.getMonth() + 1).padStart(2, '0');
        const anio = ahora.getFullYear();
        let horas = ahora.getHours();
        const minutos = String(ahora.getMinutes()).padStart(2, '0');
        const ampm = horas >= 12 ? 'PM' : 'AM';
        horas = horas % 12;
        horas = horas ? horas : 12;
        const horasStr = String(horas).padStart(2, '0');
        const fechaGeneracion = `${dia}/${mes}/${anio} ${horasStr}:${minutos} ${ampm}`;
        
        let html = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Historial - ${filtrados[0].paciente}</title><style>body{font-family:'Segoe UI',sans-serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.6;color:#333}.header{text-align:center;border-bottom:3px solid #3498db;padding-bottom:20px;margin-bottom:30px}.logo{width:300px;height:auto;margin-bottom:15px}.info-paciente{background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:30px}.sesion{border:1px solid #e0e6ed;border-radius:10px;padding:20px;margin-bottom:25px;page-break-inside:avoid}.sesion-header{background:#3498db;color:white;padding:10px 15px;border-radius:6px;margin-bottom:15px;font-weight:bold}.sesion-header.evaluacion{background:#27ae60}.sesion-categoria{color:#3498db;font-weight:600;margin:10px 0}.sesion-notas{background:#f8f9fa;padding:15px;border-left:4px solid #3498db;border-radius:4px;white-space:pre-wrap}.sesion-notas.evaluacion{border-left-color:#27ae60}@media print{body{margin:0;padding:15px}.sesion{page-break-inside:avoid}}</style></head><body><div class="header"><img src="${logoUrl}" alt="Logo" class="logo" onerror="this.style.display='none'"><h2>HISTORIA CL√çNICA</h2></div><div class="info-paciente"><p><strong>Paciente:</strong> ${filtrados[0].paciente}</p><p><strong>DNI:</strong> ${selectedDni}</p><p><strong>Fecha de generaci√≥n:</strong> ${fechaGeneracion}</p><p><strong>Total sesiones:</strong> ${filtrados.length}</p></div>`;
        
        filtrados.forEach((s, i) => {
            // Usar el campo tipo_atencion si existe, sino calcular
            let tipoAtencion, claseExtra;
            
            if (s.tipo_atencion) {
                tipoAtencion = s.tipo_atencion.toUpperCase();
                claseExtra = tipoAtencion.includes('EVALUACI√ìN') ? ' evaluacion' : '';
            } else {
                // Para registros antiguos
                const esEvaluacion = i === filtrados.length - 1;
                tipoAtencion = esEvaluacion ? 'EVALUACI√ìN FISIOTERAP√âUTICA' : `SESI√ìN ${filtrados.length - i - 1}`;
                claseExtra = esEvaluacion ? ' evaluacion' : '';
            }
            
            html += `<div class="sesion"><div class="sesion-header${claseExtra}">üìÖ ${tipoAtencion} - ${s.fecha}</div><div class="sesion-categoria">${s.categoria}</div><p style="color:#7f8c8d;font-size:14px">üë®‚Äç‚öïÔ∏è ${s.atendido_por}</p><div class="sesion-notas${claseExtra}">${s.notas}</div></div>`;
        });
        
        html += `<div style="margin-top:40px;text-align:center;color:#7f8c8d;font-size:12px;border-top:1px solid #e0e6ed;padding-top:20px"><p>¬© ${new Date().getFullYear()}</p></div></body></html>`;
        
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Historial_${filtrados[0].paciente}_${selectedDni}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        mostrarNotificacion('üì• Descargado - Abre el HTML y presiona Ctrl+P');
    }

    function showLoad(mostrar, texto = 'Cargando...') {
        document.getElementById('loading-text').innerText = texto;
        document.getElementById('loading').style.display = mostrar ? 'flex' : 'none';
    }

    function mostrarNotificacion(mensaje) {
        const notif = document.createElement('div');
        notif.style.cssText = 'position:fixed;top:20px;right:20px;background:var(--accent);color:white;padding:15px 25px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;animation:slideIn 0.3s ease';
        notif.innerText = mensaje;
        document.body.appendChild(notif);
        setTimeout(() => {
            notif.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => document.body.removeChild(notif), 300);
        }, 2500);
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
        const modalPassword = document.getElementById('modalPassword');
        const modalCita = document.getElementById('modalCita');
        if (event.target == modalPassword) {
            cerrarModalPassword();
        }
        if (event.target == modalCita) {
            cerrarModalCita();
        }
    }

    // ============================================
    // CALENDARIO Y CITAS
    // ============================================
    
    function toggleCalendar() {
        const content = document.getElementById('calendar-content');
        const btn = document.getElementById('calendar-toggle-btn');
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            btn.innerText = '‚ñº';
            localStorage.setItem('calendarExpanded', 'true');
        } else {
            content.style.display = 'none';
            btn.innerText = '‚ñ∂';
            localStorage.setItem('calendarExpanded', 'false');
        }
    }
    
    function restaurarEstadoCalendar() {
        const expanded = localStorage.getItem('calendarExpanded');
        const content = document.getElementById('calendar-content');
        const btn = document.getElementById('calendar-toggle-btn');
        
        // Por defecto, el calendario est√° expandido
        if (expanded === 'false') {
            content.style.display = 'none';
            btn.innerText = '‚ñ∂';
        } else {
            content.style.display = 'block';
            btn.innerText = '‚ñº';
        }
    }
    
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // T√≠tulo del calendario
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        document.getElementById('calendar-title').innerText = `${monthNames[month]} ${year}`;
        
        // Calcular d√≠as
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';
        
        // Headers de d√≠as
        const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        dayHeaders.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            header.innerText = day;
            grid.appendChild(header);
        });
        
        // D√≠as del mes anterior
        for (let i = firstDay - 1; i >= 0; i--) {
            const day = daysInPrevMonth - i;
            const dayEl = createDayElement(day, month - 1, year, true);
            grid.appendChild(dayEl);
        }
        
        // D√≠as del mes actual
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const isToday = day === today.getDate() && 
                           month === today.getMonth() && 
                           year === today.getFullYear();
            const dayEl = createDayElement(day, month, year, false, isToday);
            grid.appendChild(dayEl);
        }
        
        // D√≠as del siguiente mes
        const remainingDays = 42 - (firstDay + daysInMonth);
        for (let day = 1; day <= remainingDays; day++) {
            const dayEl = createDayElement(day, month + 1, year, true);
            grid.appendChild(dayEl);
        }
        
        // Mostrar citas del d√≠a seleccionado
        if (selectedDate) {
            mostrarCitasDia(selectedDate);
        }
    }
    
    function createDayElement(day, month, year, otherMonth = false, isToday = false) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        if (otherMonth) dayEl.classList.add('other-month');
        if (isToday) dayEl.classList.add('today');
        
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // Verificar si tiene citas
        const hasCitas = db.citas.some(c => c.fecha === dateStr);
        if (hasCitas) dayEl.classList.add('has-appointments');
        
        // Marcar si es la fecha seleccionada
        if (selectedDate === dateStr) dayEl.classList.add('selected');
        
        dayEl.innerText = day;
        dayEl.onclick = () => selectDay(dateStr);
        
        return dayEl;
    }
    
    function cambiarMes(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        renderCalendar();
    }
    
    function selectDay(dateStr) {
        selectedDate = dateStr;
        renderCalendar();
        mostrarCitasDia(dateStr);
    }
    
    function mostrarCitasDia(dateStr) {
        const citas = db.citas.filter(c => c.fecha === dateStr).sort((a, b) => a.hora.localeCompare(b.hora));
        const container = document.getElementById('appointments-list');
        
        if (citas.length === 0) {
            container.innerHTML = `
                <p style="text-align:center; color:#999; padding:20px; font-size:0.9rem;">
                    üìÖ Sin citas agendadas<br>
                    <button class="btn-save" onclick="abrirModalCita('${dateStr}')" style="margin-top:10px; padding:8px 15px; font-size:0.85rem;">
                        Agendar Cita
                    </button>
                </p>
            `;
            return;
        }
        
        container.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <small style="color:var(--gray); font-weight:bold;">Citas del d√≠a</small>
                <button class="btn-save" onclick="abrirModalCita('${dateStr}')" style="padding:5px 10px; font-size:0.75rem;">+ Agregar</button>
            </div>
        ` + citas.map(c => `
            <div class="appointment-item">
                <div>
                    <div class="appointment-time">${c.hora}</div>
                    <div class="appointment-patient">${c.paciente_nombre}</div>
                    ${c.notas ? `<small style="color:var(--gray); font-size:0.75rem;">${c.notas}</small>` : ''}
                </div>
                <button class="appointment-delete" onclick="eliminarCita('${c.id}')" title="Eliminar cita">‚úï</button>
            </div>
        `).join('');
    }
    
    function abrirModalCita(dateStr) {
        if (!dateStr) dateStr = selectedDate || new Date().toISOString().split('T')[0];
        selectedDate = dateStr;
        
        const [year, month, day] = dateStr.split('-');
        const monthNames = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
                           'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
        document.getElementById('cita-fecha-texto').innerText = 
            `${parseInt(day)} de ${monthNames[parseInt(month) - 1]} de ${year}`;
        
        document.getElementById('cita-hora').value = '';
        document.getElementById('cita-paciente-dni').value = '';
        document.getElementById('cita-paciente-nombre').value = '';
        document.getElementById('cita-notas').value = '';
        
        document.getElementById('modalCita').style.display = 'block';
    }
    
    function cerrarModalCita() {
        document.getElementById('modalCita').style.display = 'none';
    }
    
    function buscarPacienteCita(dni) {
        const paciente = db.pacientes.find(p => String(p.dni) === dni.trim());
        if (paciente) {
            document.getElementById('cita-paciente-nombre').value = paciente.paciente;
        }
    }
    
    async function agendarCita() {
        const hora = document.getElementById('cita-hora').value;
        const dni = document.getElementById('cita-paciente-dni').value.trim();
        const nombre = document.getElementById('cita-paciente-nombre').value.trim();
        const notas = document.getElementById('cita-notas').value.trim();
        
        if (!hora || !dni || !nombre) {
            alert('‚ö†Ô∏è Completa hora, DNI y nombre del paciente');
            return;
        }
        
        const nuevaCita = {
            id: String(Date.now()),
            fecha: selectedDate,
            hora: hora,
            paciente_dni: dni,
            paciente_nombre: nombre,
            notas: notas,
            agendado_por: currentUser.nombre_completo
        };
        
        // Agregar localmente
        db.citas = [...db.citas, nuevaCita];
        
        // Guardar en localStorage
        localStorage.setItem('citas', JSON.stringify(db.citas));
        
        cerrarModalCita();
        renderCalendar();
        mostrarCitasDia(selectedDate);
        mostrarNotificacion('‚úÖ Cita agendada');
    }
    
    function eliminarCita(id) {
        if (!confirm('¬øEliminar esta cita?')) return;
        
        db.citas = db.citas.filter(c => c.id !== id);
        localStorage.setItem('citas', JSON.stringify(db.citas));
        
        renderCalendar();
        mostrarCitasDia(selectedDate);
        mostrarNotificacion('‚úÖ Cita eliminada');
    }
    
    function cargarCitas() {
        const citasGuardadas = localStorage.getItem('citas');
        if (citasGuardadas) {
            db.citas = JSON.parse(citasGuardadas);
        }
    }

    window.onload = init;
</script>
<style>
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
</style>
</body>
</html>

